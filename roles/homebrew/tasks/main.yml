---
# File: roles/homebrew/tasks/main.yml
# (unchanged except it now uses variables from vars/main.yml)

- name: Check if Homebrew is installed
  command: which brew
  register: brew_check
  ignore_errors: true
  changed_when: false

# - name: Install Homebrew if not present
#   when: brew_check.rc != 0
#   block:
#     - name: Download and run Homebrew installer
#       command: /bin/bash -c "$(curl -fsSL https://raw.githubusercontent.com/Homebrew/install/HEAD/install.sh)"
#       args:
#         creates: /opt/homebrew/bin/brew
# 
#     - name: Add Homebrew to PATH for ARM Macs
#       lineinfile:
#         path: ~/.zprofile
#         line: 'eval "$(/opt/homebrew/bin/brew shellenv)"'
#         create: true
#       when: ansible_architecture == 'arm64'
# 
#     - name: Add Homebrew to PATH for Intel Macs
#       lineinfile:
#         path: ~/.zprofile
#         line: 'eval "$(/usr/local/bin/brew shellenv)"'
#         create: true
#       when: ansible_architecture == 'x86_64'

# - name: Update Homebrew
#   community.general.homebrew:
#     update_homebrew: true

- name: Install Homebrew packages
  community.general.homebrew:
    name: "{{ brew_packages }}"
    state: present

- name: Install Homebrew casks
  community.general.homebrew_cask:
    name: "{{ brew_casks }}"
    state: present

- name: Upgrade all Homebrew formulae and casks
  command: brew upgrade

- name: Clean up Homebrew
  command: brew cleanup